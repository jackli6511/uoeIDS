---
title: "IDS investigation worksheet"
author: "by IDS-Handsome Yue : Zhengxun Li, Jiun-Shi Huang, Yunuo Geng, Zhuoyue Dong"
date: "`r Sys.Date()`"
output: html_document
---

**Note:** You can use this file as you 'working document' where you can try out various investigation ideas and keep notes about your findings. How you use and structure this file is up to you. It is recommended that you keep notes about what you are investigating and what you find as this will make the process of creating your presentation and report easier. Please note that you _do not_ need to submit this file as part of your group project.



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib, message = FALSE}
library(tidyverse)
# Add any other libraries here
library(NHANES)
library(patchwork)
library(tidymodels)
```


```{r load-data}
# load your data 
data("NHANES")
data("NHANES",package="NHANES")
write.csv(NHANES,"data/NHANES.csv",row.names=FALSE)
health<-read.csv("data/NHANES.csv")
#names(health)
#DaysPhysHlthBad DaysMentHlthBad Alcohol RegularMarij HardDrugs
data_u <- health %>% select(ID,DaysPhysHlthBad,DaysMentHlthBad,AlcoholYear,RegularMarij,HardDrugs)
data_c <- data_u %>% drop_na()
data_c <- data_c %>% mutate(
  Marij=case_when(
    RegularMarij=="No"~0,
    RegularMarij=="Yes"~1
  )
)
data_c <- data_c %>% mutate(
  Drugs=case_when(
    HardDrugs=="No"~0,
    HardDrugs=="Yes"~2
  )
)
data_c<-data_c %>% select(ID,DaysPhysHlthBad,DaysMentHlthBad,AlcoholYear,Marij,Drugs)
data_c<-data_c %>% mutate(Drugsindex=Marij+Drugs)
data_c<-data_c %>% mutate(TotalUnhealthy=DaysPhysHlthBad+DaysMentHlthBad)
data_c <- data_c %>% mutate(
  healthstatus=case_when(
    TotalUnhealthy<=14~1,
    TotalUnhealthy>=15~0
  )
)
data_c <- data_c %>% mutate(
  Alcoholindex=case_when(
    AlcoholYear==0~0,
    AlcoholYear<=52~1,
    AlcoholYear<=104~2,
    AlcoholYear<=156~3,
    AlcoholYear>156~4
  )
)
data_h<-data_c %>% select(ID,Drugsindex,Alcoholindex,healthstatus)
set.seed(511)
data_split <- initial_split(data_h, prop = 0.80,strata=healthstatus)
train_data <- training(data_split)
test_data  <- testing(data_split)

my_theme <- theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "bottom")

p1 <- ggplot(train_data, aes(x = factor(Alcoholindex))) +
  geom_bar(fill = "steelblue", alpha = 0.8) +
  labs(title = "Alcohol Index Distribution", x = "Alcohol Index", y = "Frequency") +
  my_theme

p2 <- ggplot(train_data, aes(x = factor(Drugsindex))) +
  geom_bar(fill = "coral", alpha = 0.8) +
  labs(title = "Drug Index Distribution", x = "Drug Index", y = "Frequency") +
  my_theme

p3 <- ggplot(train_data, aes(x = factor(healthstatus))) +
  geom_bar(fill = "darkgreen", alpha = 0.8) +
  labs(title = "HealthStatusDistribution", x = "Health Status",          y="Frequency") +
  my_theme
pa<-(p1 | p2 | p3) + plot_annotation(title = "Variable Distribution Overview")
pa
p4 <- ggplot(train_data, aes(x = factor(Alcoholindex), fill = factor(healthstatus))) +
  geom_bar(position = "fill") +
  labs(title = "Health Status Proportions by Alcohol Index", 
       x = "Alcohol Index", 
       y = "Proportion",
       fill = "Health Status") +
  scale_fill_manual(values = c("0" = "red", "1" = "green"),
                    labels = c("Unhealthy", "Healthy")) +
  my_theme

p5 <- ggplot(train_data, aes(x = factor(Drugsindex), fill = factor(healthstatus))) +
  geom_bar(position = "fill") +
  labs(title = "Health Status Proportions by Drug Index", 
       x = "Drug Index", 
       y = "Proportion",
       fill = "Health Status") +
  scale_fill_manual(values = c("0" = "red", "1" = "green"),
                    labels = c("Unhealthy", "Healthy")) +
  my_theme
pb<-p4 / p5
pb
p7 <- ggplot(train_data, aes(x = factor(healthstatus), y = Alcoholindex, fill = factor(healthstatus))) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Alcohol Index Distribution by Health Status", 
       x = "Health Status", 
       y = "Alcohol Index",
       fill = "Health Status") +
  scale_fill_manual(values = c("0" = "red", "1" = "green"),
                    labels = c("Unhealthy", "Healthy")) +
  scale_x_discrete(labels = c("Unhealthy", "Healthy")) +
  my_theme

p8 <- ggplot(train_data, aes(x = factor(healthstatus), y = Drugsindex, fill = factor(healthstatus))) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Drug Index Distribution by Health Status", 
       x = "Health Status", 
       y = "Drug Index",
       fill = "Health Status") +
  scale_fill_manual(values = c("0" = "red", "1" = "green"),
                    labels = c("Unhealthy", "Healthy")) +
  scale_x_discrete(labels = c("Unhealthy", "Healthy")) +
  my_theme
pc<-p7 / p8
pc
train_data <- train_data %>%
  mutate(
    Alcoholindex = factor(Alcoholindex),
    Drugsindex = factor(Drugsindex),
    healthstatus = factor(healthstatus, levels = c(0, 1), labels = c("unHealthy", "Healthy"))
  )

test_data <- test_data %>%
  mutate(
    Alcoholindex = factor(Alcoholindex),
    Drugsindex = factor(Drugsindex),
    healthstatus = factor(healthstatus, levels = c(0, 1), labels = c("unHealthy", "Healthy"))
  )

model_fit <- logistic_reg() %>% 
  set_engine("glm") %>% 
  fit(healthstatus ~ Alcoholindex + Drugsindex, 
      data = train_data, 
      family = "binomial")
model_summary <- tidy(model_fit)
model_summary

test_predictions <- predict(model_fit, new_data = test_data, type = "prob") %>%
  bind_cols(
    predict(model_fit, new_data = test_data, type = "class"),
    test_data %>% select(healthstatus)
  )
test_predictions

roc_curve <- test_predictions %>%
  roc_curve(
    truth = healthstatus,
    .pred_Healthy, 
    event_level = "second"  
  )
roc_plot <- roc_curve %>%
  autoplot() +
  labs(
    title = "ROC Curve for Health Status Prediction",
    subtitle = "Alcohol and Drug Indices as Predictors"
  ) +
  my_theme +
  theme(legend.position = "none")
roc_plot

auc_value <- test_predictions %>%
  roc_auc(
    truth = healthstatus,
    .pred_Healthy,
    event_level = "second"
  )
auc_value
#ggsave("C:/Users/Jack/Documents/uoeIDS/img/p1.png",plot=pa)
#ggsave("C:/Users/Jack/Documents/uoeIDS/img/p2.png",plot=pb)
#ggsave("C:/Users/Jack/Documents/uoeIDS/img/p3.png",plot=pc)
#ggsave("C:/Users/Jack/Documents/uoeIDS/img/p4.png",plot=roc_plot)
```

```{r load-daa}

# load your data
data("NHANES")
data("NHANES", package="NHANES")
write.csv(NHANES, "data/NHANES.csv", row.names = FALSE)

health <- read.csv("data/NHANES.csv")

data_r <- health %>% select(
  ID,
  DaysPhysHlthBad,
  DaysMentHlthBad,
  SleepHrsNight,
  SleepTrouble
)
 
data_cl <- data_r %>% drop_na()


data_cl <- data_cl %>% mutate(
  Trouble = case_when(
    SleepTrouble == "No"  ~ 0,
    SleepTrouble == "Yes" ~ 1
  )
)

data_cl <- data_cl %>% mutate(
  SleepCat = case_when(
    SleepHrsNight < 6 ~ "Short",
    SleepHrsNight >= 6 & SleepHrsNight <= 8 ~ "Normal",
    SleepHrsNight > 8 ~ "Long"
  )
)

data_end <- data_cl %>% select(
  ID,
  DaysPhysHlthBad,
  DaysMentHlthBad,
  SleepHrsNight,
  Trouble,
  SleepCat
)

data_end
data_end <- data_end %>%
  mutate(Trouble = factor(Trouble, levels = c(0, 1),
                          labels = c("No Trouble", "Trouble")))
p5<-ggplot(data_end, aes(x = SleepCat, fill = Trouble)) +
  geom_bar() +
  labs(
    title = "Sleep Trouble by Sleep Duration Category",
    x = "Sleep Duration Category",
    y = "Count",
    fill = "Sleep Trouble"
  ) +
  theme_minimal()
p5
p6<-ggplot(data_end, aes(x = SleepCat, fill = Trouble)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Proportion with Sleep Trouble by Sleep Duration Category",
    x = "Sleep Duration Category",
    y = "Proportion",
    fill = "Sleep Trouble"
  ) +
  theme_minimal()
p6
set.seed(123)

# Make sure Trouble is a factor (done above, but just to be safe)
data_end <- data_end %>%
  mutate(Trouble = factor(Trouble, levels = c("No Trouble", "Trouble")))
data_split <- initial_split(data_end, prop = 0.7, strata = Trouble)
train_data <- training(data_split)
test_data  <- testing(data_split)
sleep_rec <- recipe(Trouble ~ DaysPhysHlthBad + DaysMentHlthBad + SleepHrsNight + SleepCat,
                    data = train_data) %>%
  step_dummy(all_nominal_predictors())
log_spec <- logistic_reg(mode = "classification") %>%
  set_engine("glm")
sleep_wf <- workflow() %>%
  add_recipe(sleep_rec) %>%
  add_model(log_spec)

sleep_fit <- fit(sleep_wf, data = train_data)
test_preds <- predict(sleep_fit, test_data, type = "prob") %>%
  bind_cols(test_data)
roc_df <- roc_curve(test_preds,
                    truth = Trouble,       
                    .pred_Trouble)          

roc2<-autoplot(roc_df) +
  labs(
    title = "ROC Curve for Sleep Trouble Model",
    x = "1 - Specificity",
    y = "Sensitivity"
  )
roc2
roc_auc(test_preds,
        truth = Trouble,
        .pred_Trouble)
#ggsave("C:/Users/Jack/Documents/uoeIDS/img/p5.png",plot=p5)
#ggsave("C:/Users/Jack/Documents/uoeIDS/img/p6.png",plot=p6)
#ggsave("C:/Users/Jack/Documents/uoeIDS/img/p7.png",plot=roc2)
```
